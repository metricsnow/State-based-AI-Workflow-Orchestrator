# Docker Compose Environment Testing Suite

Comprehensive pytest-based test suite for validating Docker Compose environment setup (TASK-001).

## Test Structure

```
tests/
├── __init__.py              # Package initialization
├── conftest.py              # Pytest fixtures and configuration
├── test_docker_compose.py   # Docker Compose config and setup tests
├── test_services.py         # Service health and functionality tests
├── test_networking.py       # Network connectivity tests
├── test_volumes.py          # Volume persistence tests
├── requirements-test.txt    # Test dependencies
└── README.md               # This file
```

## Test Categories

### 1. Docker Compose Configuration Tests (`test_docker_compose.py`)
- Docker Compose file syntax validation
- Service definitions verification
- .env file validation
- Directory structure checks
- Docker installation verification

**Markers**: `@pytest.mark.docker`

### 2. Service Health Tests (`test_services.py`)
- Service startup verification
- Health check validation
- Log error detection
- Service status monitoring

**Markers**: `@pytest.mark.docker`, `@pytest.mark.integration`, `@pytest.mark.health`, `@pytest.mark.slow`

### 3. Network Connectivity Tests (`test_networking.py`)
- Port accessibility
- Service-to-service communication
- Kafka connectivity
- Airflow UI accessibility

**Markers**: `@pytest.mark.docker`, `@pytest.mark.integration`, `@pytest.mark.network`

### 4. Volume Persistence Tests (`test_volumes.py`)
- PostgreSQL data persistence
- Volume existence verification
- Data integrity across restarts

**Markers**: `@pytest.mark.docker`, `@pytest.mark.integration`, `@pytest.mark.slow`, `@pytest.mark.volume`

## Installation

1. **Activate virtual environment**:
   ```bash
   source venv/bin/activate
   ```

2. **Install test dependencies**:
   ```bash
   pip install -r tests/requirements-test.txt
   ```

## Running Tests

### Run All Tests
```bash
pytest tests/
```

### Run Specific Test Categories

**Configuration tests only** (fast, no services required):
```bash
pytest tests/test_docker_compose.py -m docker
```

**Integration tests** (requires running services):
```bash
pytest tests/test_services.py tests/test_networking.py tests/test_volumes.py -m integration
```

**Health check tests only**:
```bash
pytest tests/test_services.py -m health
```

**Network tests only**:
```bash
pytest tests/test_networking.py -m network
```

**Volume tests only**:
```bash
pytest tests/test_volumes.py -m volume
```

### Run with Coverage
```bash
pytest tests/ --cov=. --cov-report=html --cov-report=term-missing
```

### Run with Verbose Output
```bash
pytest tests/ -v
```

### Run Specific Test
```bash
pytest tests/test_docker_compose.py::TestDockerComposeConfig::test_docker_compose_syntax_valid
```

## Test Fixtures

### Session-Scoped Fixtures
- `docker_compose_file`: Path to docker-compose.yml
- `env_file`: Path to .env file
- `docker_compose_services`: List of required services
- `docker_compose_up`: Starts services before tests, stops after

### Function-Scoped Fixtures
- `docker_compose_exec`: Helper to execute commands in containers
- `service_health_checks`: Health check commands per service
- `required_ports`: Required ports mapping

## Prerequisites

Before running integration tests:

1. **Ensure .env file exists** with FERNET_KEY:
   ```bash
   ./scripts/generate-fernet-key.sh
   ```

2. **Start services** (or use `docker_compose_up` fixture):
   ```bash
   docker-compose up -d
   ```

3. **Wait for services to be healthy**:
   ```bash
   docker-compose ps
   ```

## Test Execution Flow

1. **Pre-flight checks** (`test_docker_compose.py`):
   - Validates configuration without starting services
   - Fast execution (< 5 seconds)

2. **Integration tests** (other test files):
   - Requires services to be running
   - Uses `docker_compose_up` fixture for automatic setup/teardown
   - Slower execution (2-5 minutes)

## Continuous Integration

Tests are designed to run in CI/CD pipelines:

```yaml
# Example GitHub Actions
- name: Run Docker Compose tests
  run: |
    source venv/bin/activate
    pip install -r tests/requirements-test.txt
    pytest tests/ -v --tb=short
```

## Troubleshooting

### Services Not Starting
- Check Docker daemon is running: `docker ps`
- Verify .env file exists and has FERNET_KEY
- Check port conflicts: `lsof -i :8080`

### Tests Timing Out
- Increase timeout in `conftest.py` `docker_compose_up` fixture
- Check service logs: `docker-compose logs`

### Health Checks Failing
- Wait longer for services to initialize
- Check service-specific logs
- Verify health check commands are correct

## Test Coverage Goals

- **Configuration tests**: 100% coverage
- **Service tests**: >80% coverage
- **Integration tests**: >70% coverage

## Notes

- Integration tests require Docker and Docker Compose to be installed
- Some tests may take 2-5 minutes to complete
- Volume persistence tests modify database state
- Network tests require services to be accessible on localhost

